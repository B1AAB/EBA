"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9516],{1047:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"bitcoin/etl/s2-traverse-bitcoin","title":"Extract Block Data","description":"Step 2. Traversing Blocks for Initial Data Extraction","source":"@site/docs/bitcoin/etl/s2-traverse-bitcoin.md","sourceDirName":"bitcoin/etl","slug":"/bitcoin/etl/traverse","permalink":"/docs/bitcoin/etl/traverse","draft":false,"unlisted":false,"editUrl":"https://github.com/B1AAB/EBA/edit/main/website/docs/bitcoin/etl/s2-traverse-bitcoin.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Extract Block Data","description":"Step 2. Traversing Blocks for Initial Data Extraction","sidebar_position":1,"slug":"/bitcoin/etl/traverse"},"sidebar":"tutorialSidebar","previous":{"title":"Sync a Bitcoin Node","permalink":"/docs/bitcoin/etl/node-sync"},"next":{"title":"Address Statistics","permalink":"/docs/bitcoin/etl/address-stats"}}');var s=i(4848),o=i(8453);const r={title:"Extract Block Data",description:"Step 2. Traversing Blocks for Initial Data Extraction",sidebar_position:1,slug:"/bitcoin/etl/traverse"},a=void 0,c={},l=[{value:"Performance and Scalability",id:"performance-and-scalability",level:3},{value:"Deduplicate Nodes",id:"deduplicate-nodes",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components},{Details:i}=n;return i||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["EBA connects to a ",(0,s.jsx)(n.a,{href:"/docs/bitcoin/etl/node-sync",children:"fully synchronized Bitcoin Core"}),"\nnode and iterates through a set of blocks,\nextracts transaction data, and encodes them as temporal heterogeneous graph."]}),"\n",(0,s.jsx)(n.p,{children:"For this task, you may take the following steps."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"/docs/gs/installation",children:"Install the program"}),", if you have not installed already."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Make sure ",(0,s.jsx)(n.code,{children:"Bitcoin Core"})," is running and responding to API calls (see ",(0,s.jsx)(n.a,{href:"/docs/bitcoin/etl/node-sync",children:"this page"}),")."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Run ",(0,s.jsx)(n.code,{children:"eba"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:".\\eba.exe bitcoin traverse --from 0 --to 1000\n"})}),"\n",(0,s.jsx)(n.p,{children:"or if you want to track txo (for downstream statistics only) and the traverse window is wide, then you may use:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:".\\eba.exe bitcoin traverse --to 863000 --track-txo --max-entries-per-batch 50000000\n"})}),"\n",(0,s.jsx)(n.p,{children:"You may use the following to get all the arguments and their documentation."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:".\\eba.exe bitcoin traverse --help\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"performance-and-scalability",children:"Performance and Scalability"}),"\n",(0,s.jsx)(n.p,{children:"Traversing Bitcoin blocks can take a considerable amount of time.\nTo accelerate this,\nEBA heavily leverages multi-threading,\nand all time-consuming operations are implemented to be non-blocking.\nIt also minimizes the latency between submitting API calls and\nprocessing the returned data,\nwhich allows data to be handled in parallel threads,\nso it doesn't wait to encode and persist a block's graph elements before processing the next block.\nHowever, there is a limit to how many concurrent requests EBA and Bitcoin Core can process optimally.\nTherefore, despite these optimizations,\nif both applications are running on the same machine,\ntheir performance is ultimately bound by its I/O limits,\nprimarily the random read/write performance of the storage."}),"\n",(0,s.jsxs)(n.p,{children:["Since EBA processes each block independently,\none potential improvement is to deploy the application on a Kubernetes (k8s) cluster\n(requires dockerizing both EBA and Bitcoin Core).\nIn this setup, each instance of EBA service could process a subset of blocks\nwhile a load balancer directs its API calls to replicas of the Bitcoin Core services.\nThis horizontal scaling would significantly improve performance;\nhowever, because this requires a k8s cluster and cloud or on-premises HPC resources\nthat may not be ",(0,s.jsx)(n.a,{href:"/docs/gs/accessibility",children:"widely accessible"}),",\nthe specifics of such a deployment are not currently covered."]}),"\n",(0,s.jsx)(n.h2,{id:"deduplicate-nodes",children:"Deduplicate Nodes"}),"\n",(0,s.jsxs)(n.p,{children:["This step deduplicates the\n",(0,s.jsx)(n.code,{children:"Tx"})," (",(0,s.jsx)(n.code,{children:"[0-9]*_BitcoinTxNode.csv.gz"}),") and\n",(0,s.jsx)(n.code,{children:"Script"})," (",(0,s.jsx)(n.code,{children:"[0-9]*_BitcoinScriptNode.csv.gz"}),")\nnode files."]}),"\n",(0,s.jsxs)(i,{children:[(0,s.jsx)("summary",{children:"Why is deduplication required?"}),(0,s.jsxs)(n.p,{children:["For performance reasons,\nEBA does not attempt to ensure uniqueness in the ",(0,s.jsx)(n.code,{children:"Tx"})," and ",(0,s.jsx)(n.code,{children:"Script"})," files\nduring the initial traversal.\nInstead, it writes nodes as it encounters them.\nA ",(0,s.jsx)(n.code,{children:"Tx"})," node is created once when the block containing the transaction is parsed,\nand again every time that transaction is referenced as a ",(0,s.jsx)(n.code,{children:"txin"})," in subsequent blocks.\nThe same applies to ",(0,s.jsx)(n.code,{children:"Script"})," nodes.\nConsequently, the ",(0,s.jsx)(n.code,{children:"Tx"})," and ",(0,s.jsx)(n.code,{children:"Script"})," nodes files contain a high degree of duplication."]}),(0,s.jsx)(n.p,{children:'Crucially, the instance of the node created where the transaction\noriginated contains detailed information,\nwhereas references in subsequent blocks contain minimal information.\nThis means some duplicate entries are rich in data while others\nare missing feature values.\nTherefore, we must deduplicate the files by "merging" duplicates\ninto a single node that retains values for all features.'}),(0,s.jsxs)(n.p,{children:["This step is critical for the Neo4j import process.\nWhile the Neo4j admin tool offers a ",(0,s.jsx)(n.code,{children:"--skip-duplicate-nodes"})," flag,\nrelying on it is discouraged because it only tolerates\na limited number of duplicates,\nand increasing that limit incurs significant performance penalties.\nFurthermore, Neo4j does not support the merging of data described above;\nit would simply discard subsequent entries."]})]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"cd"})," to the directory where the data is persisted."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Combine the files:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"zcat [0-9]*_BitcoinTxNode.csv.gz > combined_BitcoinTxNode.csv\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"zcat [0-9]*_BitcoinScriptNode.csv.gz > combined_BitcoinScriptNode.csv\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Sort the files.\nNote: Since these files can be very large,\nthe command below is configured to use temporary on-disk files.\nEnsure you have sufficient disk space (at least as much as the ",(0,s.jsx)(n.code,{children:"combined_*"})," files)\nand are running on performant media (e.g., NVMe).\nAdjust the ",(0,s.jsx)(n.code,{children:"--buffer-size"})," according to the available memory on your machine."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"LC_ALL=C sort --buffer-size=32G --parallel=16 --temporary-directory=. -t$'\\t' -k1,1 combined_BitcoinTxNode.csv > sorted_BitcoinTxNode.csv\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"LC_ALL=C sort --buffer-size=32G --parallel=16 --temporary-directory=. -t$'\\t' -k1,1 combined_BitcoinScriptNode.csv > sorted_BitcoinScriptNode.csv\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Run the following command to deduplicate the files:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:".\\eba.exe bitcoin dedup --sorted-script-nodes-file sorted_BitcoinScriptNode.csv --sorted-tx-nodes-file sorted_BitcoinTxNode.csv\n"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>a});var t=i(6540);const s={},o=t.createContext(s);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);