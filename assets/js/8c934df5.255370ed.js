"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7363],{1048:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"bitcoin/etl/s5-import-neo4j","title":"Import into neo4j","description":"Step 5. Import into neo4j","source":"@site/docs/bitcoin/etl/s5-import-neo4j.md","sourceDirName":"bitcoin/etl","slug":"/bitcoin/etl/import","permalink":"/docs/bitcoin/etl/import","draft":false,"unlisted":false,"editUrl":"https://github.com/B1AAB/EBA/edit/main/website/docs/bitcoin/etl/s5-import-neo4j.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Import into neo4j","description":"Step 5. Import into neo4j","sidebar_position":4,"slug":"/bitcoin/etl/import"},"sidebar":"tutorialSidebar","previous":{"title":"TXO Lifecycle","permalink":"/docs/bitcoin/etl/txo-lifecycle"},"next":{"title":"Overview","permalink":"/docs/bitcoin/sampling/overview"}}');var o=t(4848),s=t(8453);const a={title:"Import into neo4j",description:"Step 5. Import into neo4j",sidebar_position:4,slug:"/bitcoin/etl/import"},r=void 0,d={},l=[{value:"Initial Data Load",id:"full",level:2},{value:"Incremental Update",id:"incremental",level:2},{value:"Load database dump",id:"load",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["Neo4j's ",(0,o.jsx)(n.a,{href:"https://neo4j.com/docs/operations-manual/4.4/tools/neo4j-admin/neo4j-admin-import/",children:"neo4j-admin import tool"}),"\noffers the fastest method for initially populating a database.\nIts main drawback is that it requires the database to be empty;\nhence, it doesn't support incremental updates.\nTherefore, we provide separate solutions optimized for both\ninitial population and incremental updates."]}),"\n",(0,o.jsx)(n.h2,{id:"full",children:"Initial Data Load"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"[Experimental] you need to run a script that takes batches CSV files,\ncombines them into single file per node or relationship type, and formats them\nin a way that neo4j admin tool can use it."}),"\n",(0,o.jsx)(n.p,{children:"1.1. Run:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"EXP_PrepareDataForNeo4j\n"})}),"\n",(0,o.jsx)(n.p,{children:"Since we need to avoid duplicates in node definitions, and due to file size and memory usage contraints,\nthis first step will not attempt to avoid duplicates, instead it will output files\nwhose duplicates will be removed in the following steps."}),"\n",(0,o.jsxs)(n.p,{children:["1.2. ",(0,o.jsx)(n.code,{children:"cd"})," to the directory where the data is persisted"]}),"\n",(0,o.jsx)(n.p,{children:"1.3. Combine the files:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"cat *_BitcoinTxNode.tsv > combined_BitcoinTxNode.tsv\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"cat *_BitcoinScriptNode.tsv > combined_BitcoinScriptNode.tsv\n"})}),"\n",(0,o.jsxs)(n.p,{children:["1.4. Sort the files:\n(The goal of the following is to de-duplicate the Tx and Script node files. neo4j has the argument ",(0,o.jsx)(n.code,{children:"--skip-duplicate-nodes[=true|false]"})," that can be used as an alternative to the following.)"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"LC_ALL=C sort --buffer-size=32G --parallel=16 --temporary-directory=. -t$'\\t' -k1,1 combined_BitcoinTxNode.tsv > sorted_BitcoinTxNode.tsv\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"LC_ALL=C sort --buffer-size=32G --parallel=16 --temporary-directory=. -t$'\\t' -k1,1 combined_BitcoinScriptNode.tsv > sorted_BitcoinScriptNode.tsv\n"})}),"\n",(0,o.jsxs)(n.p,{children:["1.5. Run the application ",(0,o.jsx)(n.code,{children:"EXP_ProcessSortedNodeFiles"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://neo4j.com/docs/desktop/current/operations/database-management/#_create_a_new_database",children:"Create a neo4j database"}),",\nor if using an existing database, make sure it is empty."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Stop the database if it is running."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"cd"})," to the database's import directory, for instance:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"C:\\neo4j\\relate-data\\dbmss\\dbms-5739a8c7-7235-4e8a-a2ad-7b708514efce\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Use the following command to load data into neo4j empty data base using the admin tools."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:'$ENV:GDIR=""  # set to the directory containing graph data without the trailing `\\`\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:'$ENV:HEAP_SIZE = "96G"  # set the heap size for the neo4j-admin tool\n'})}),"\n",(0,o.jsx)(n.p,{children:"Note that if you change the name of the database in the following, you will need to\ncreate that database in neo4j first, then run the import command."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",metastring:'title="neo4j admin"',children:'.\\bin\\neo4j-admin.ps1 database import full --overwrite-destination neo4j `\n--nodes="$ENV:GDIR\\BitcoinCoinbase.tsv.gz" `\n--nodes="$ENV:GDIR\\BitcoinGraph_header.tsv.gz,$ENV:GDIR\\0_BitcoinGraph.tsv.gz" `\n--nodes="$ENV:GDIR\\BitcoinScriptNode_header.tsv.gz,$ENV:GDIR\\unique_BitcoinScriptNode.tsv.gz" `\n--nodes="$ENV:GDIR\\BitcoinTxNode_header.tsv.gz,$ENV:GDIR\\unique_BitcoinTxNode.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinS2S_header.tsv.gz,$ENV:GDIR\\.*BitcoinS2S.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinT2T_header.tsv.gz,$ENV:GDIR\\.*BitcoinT2T.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinC2T_header.tsv.gz,$ENV:GDIR\\.*BitcoinC2T.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinC2S_header.tsv.gz,$ENV:GDIR\\.*BitcoinC2S.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinB2T_header.tsv.gz,$ENV:GDIR\\.*BitcoinB2T.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinB2S_header.tsv.gz,$ENV:GDIR\\.*BitcoinB2S.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinS2B_header.tsv.gz,$ENV:GDIR\\.*BitcoinS2B.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinT2B_header.tsv.gz,$ENV:GDIR\\.*BitcoinT2B.tsv.gz" `\n--delimiter "\\t" --array-delimiter ";" --verbose\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",metastring:'title="neo4j admin (skip duplicates)"',children:'.\\bin\\neo4j-admin.ps1 database import full --overwrite-destination neo4j `\n--nodes="$ENV:GDIR\\BitcoinCoinbase.tsv.gz" `\n--nodes="$ENV:GDIR\\BitcoinGraph_header.tsv.gz,$ENV:GDIR\\0_BitcoinGraph.tsv.gz" `\n--nodes="$ENV:GDIR\\BitcoinScriptNode_header.tsv.gz,$ENV:GDIR\\unique_BitcoinScriptNode.tsv.gz" `\n--nodes="$ENV:GDIR\\BitcoinTxNode_header.tsv.gz,$ENV:GDIR\\unique_BitcoinTxNode.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinS2S_header.tsv.gz,$ENV:GDIR\\.*BitcoinS2S.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinT2T_header.tsv.gz,$ENV:GDIR\\.*BitcoinT2T.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinC2T_header.tsv.gz,$ENV:GDIR\\.*BitcoinC2T.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinC2S_header.tsv.gz,$ENV:GDIR\\.*BitcoinC2S.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinB2T_header.tsv.gz,$ENV:GDIR\\.*BitcoinB2T.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinB2S_header.tsv.gz,$ENV:GDIR\\.*BitcoinB2S.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinS2B_header.tsv.gz,$ENV:GDIR\\.*BitcoinS2B.tsv.gz" `\n--relationships="$ENV:GDIR\\BitcoinT2B_header.tsv.gz,$ENV:GDIR\\.*BitcoinT2B.tsv.gz" `\n--delimiter "\\t" --array-delimiter ";" --verbose --skip-duplicate-nodes\n\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Enable ",(0,o.jsx)(n.a,{href:"https://neo4j.com/docs/apoc/current/installation/",children:"APOC"}),"."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"incremental",children:"Incremental Update"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Enable ",(0,o.jsx)(n.a,{href:"https://neo4j.com/docs/apoc/current/installation/",children:"APOC"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Make sure to increase the max heap size for neo4j, otherwise you may get the following error message:"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"There is not enough memory to perform the current task.\nPlease try increasing 'dbms.memory.heap.max_size' in\nthe neo4j configuration (normally in 'conf/neo4j.conf'\nor, if you are using Neo4j Desktop, found through the\nuser interface) or if you are running an embedded\ninstallation increase the heap by using '-Xmx'\ncommand line flag, and then restart the database."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Run (Use ",(0,o.jsx)(n.code,{children:"--help"})," for usage docs):"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"eba bitcoin import\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"load",children:"Load database dump"}),"\n",(0,o.jsx)(n.p,{children:"We also provide a dump of the neo4j database containing the entire bitcoin graph.\nIn order to use this, you may take the following steps:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"/releases/data-release/v1",children:"Download the dump"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Import into neo4j. You may follow the steps outlined\n",(0,o.jsx)(n.a,{href:"https://neo4j.com/docs/operations-manual/current/backup-restore/restore-dump/",children:"on this page"}),"\nfor importing the downloaded database dump. Or, you may run the following."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:".\\bin\\neo4j-admin.bat database load --overwrite-destination=true --verbose --from-path=M:\\\\ neo4j\n"})}),"\n",(0,o.jsxs)(n.p,{children:["This process may take a few hours and needs 2.722TiB storage.\nIf it asks for password, you may enter ",(0,o.jsx)(n.code,{children:"password"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Enable ",(0,o.jsx)(n.a,{href:"https://neo4j.com/docs/apoc/current/installation/",children:"APOC"}),"."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var i=t(6540);const o={},s=i.createContext(o);function a(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);