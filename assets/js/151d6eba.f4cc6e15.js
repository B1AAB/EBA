"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[30],{4357:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>r,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"bitcoin/etl/s5a-import","title":"Import into neo4j","description":"Step 5. Import into neo4j","source":"@site/docs/bitcoin/etl/s5a-import.md","sourceDirName":"bitcoin/etl","slug":"/bitcoin/etl/import","permalink":"/docs/bitcoin/etl/import","draft":false,"unlisted":false,"editUrl":"https://github.com/B1AAB/EBA/edit/main/website/docs/bitcoin/etl/s5a-import.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Import into neo4j","description":"Step 5. Import into neo4j","sidebar_position":4,"slug":"/bitcoin/etl/import"},"sidebar":"tutorialSidebar","previous":{"title":"TXO Lifecycle","permalink":"/docs/bitcoin/etl/txo-lifecycle"},"next":{"title":"Restore database dump","permalink":"/docs/bitcoin/etl/restore"}}');var s=i(4848),o=i(8453);const r={title:"Import into neo4j",description:"Step 5. Import into neo4j",sidebar_position:4,slug:"/bitcoin/etl/import"},a=void 0,c={},d=[];function l(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components},{Details:i}=t;return i||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.admonition,{title:"Do I need to run the bulk import process?",type:"tip",children:[(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Yes,"}),"\nif you need to modify the graph structure or append new data that is not included in\n",(0,s.jsx)(t.a,{href:"/releases/tags/data-releases",children:"our release"}),".\n",(0,s.jsx)(t.em,{children:"Note: This is highly resource-intensive and can take 2-3 weeks on a standard desktop."})]}),(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"No,"}),"\nif you simply want to explore the graph or\n",(0,s.jsx)(t.a,{href:"/docs/bitcoin/sampling/overview",children:"sample communities"})," from the dataset.\nIn this case, ",(0,s.jsx)(t.a,{href:"./restore",children:"restore database dump"})," instead; it bypasses the weeks-long processing time required for the bulk import described on this page."]})]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://neo4j.com/docs/operations-manual/4.4/tools/neo4j-admin/neo4j-admin-import/",children:(0,s.jsx)(t.code,{children:"neo4j-admin"})}),"\noffers the highest throughput method for populating a massive database.\nIts primary constraint is that it requires an empty database,\nmeaning it does not support incremental updates to an existing graph."]}),"\n",(0,s.jsxs)(i,{children:[(0,s.jsx)("summary",{children:"Optional: Manual Pre-processing (Experimental)"}),(0,s.jsxs)(t.p,{children:["This optional step performs manual deduplication of nodes\nto improve the Neo4j import process.\nWhile the Neo4j admin tool offers a ",(0,s.jsx)(t.code,{children:"--skip-duplicate-nodes"})," flag,\npre-sorting and deduplicating via the command line is often\nmore memory-efficient for datasets of this scale."]}),(0,s.jsxs)(t.p,{children:["a.1. Run the ",(0,s.jsx)(t.em,{children:"experimental"})," application ",(0,s.jsx)(t.code,{children:"EXP_PrepareDataForNeo4j"}),"."]}),(0,s.jsx)(t.p,{children:"Due to memory constraints,\nthis step aggregates files but does not strictly deduplicate them;\nit outputs intermediate files intended for sorting."}),(0,s.jsxs)(t.p,{children:["a.2. ",(0,s.jsx)(t.code,{children:"cd"})," to the directory where the data is persisted"]}),(0,s.jsx)(t.p,{children:"a.3. Combine the files:"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cat *_BitcoinTxNode.tsv > combined_BitcoinTxNode.tsv\n"})}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cat *_BitcoinScriptNode.tsv > combined_BitcoinScriptNode.tsv\n"})}),(0,s.jsxs)(t.p,{children:["a.4. Sort the files:\n(The goal of the following is to de-duplicate the Tx and Script node files. neo4j has the argument ",(0,s.jsx)(t.code,{children:"--skip-duplicate-nodes[=true|false]"})," that can be used as an alternative to the following.)"]}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"LC_ALL=C sort --buffer-size=32G --parallel=16 --temporary-directory=. -t$'\\t' -k1,1 combined_BitcoinTxNode.tsv > sorted_BitcoinTxNode.tsv\n"})}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"LC_ALL=C sort --buffer-size=32G --parallel=16 --temporary-directory=. -t$'\\t' -k1,1 combined_BitcoinScriptNode.tsv > sorted_BitcoinScriptNode.tsv\n"})}),(0,s.jsxs)(t.p,{children:["a.5. Run the ",(0,s.jsx)(t.em,{children:"experimental"})," application ",(0,s.jsx)(t.code,{children:"EXP_ProcessSortedNodeFiles"}),"."]})]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://neo4j.com/docs/desktop/current/operations/database-management/#_create_a_new_database",children:"Create a neo4j database"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"If you are using an existing database instance,\nensure the target database is empty and shut down."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"sudo systemctl stop neo4j\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Set an environment variable pointing to the directory containing the Bitcoin graph TSV files."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:'export GDIR="<set to the dir that contains graph data>"\n'})}),"\n",(0,s.jsx)(t.p,{children:"Verify that your data directory contains the correctly batched files.\nYou can use the following command to inspect the file distribution by type\n(ignoring timestamp prefixes):"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:'ls -1 | sed -E "s/^[0-9]+_/[Timestamp]_/" | sort | uniq -c\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You should see header files (e.g., ",(0,s.jsx)(t.code,{children:"BitcoinGraph_header.tsv.gz"}),"),\nbatched edge files (e.g., ",(0,s.jsx)(t.code,{children:"195 [Timestamp]_BitcoinS2S.tsv.gz"}),"), and the unique node files."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"1   BitcoinB2S_header.tsv.gz\n1   BitcoinB2T_header.tsv.gz\n1   BitcoinC2S_header.tsv.gz\n1   BitcoinC2T_header.tsv.gz\n1   BitcoinCoinbase.tsv.gz\n1   BitcoinGraph_header.tsv.gz\n1   BitcoinS2B_header.tsv.gz\n1   BitcoinS2S_header.tsv.gz\n1   BitcoinScriptNode_header.tsv.gz\n1   BitcoinT2B_header.tsv.gz\n1   BitcoinT2T_header.tsv.gz\n1   BitcoinTxNode_header.tsv.gz\n195 [Timestamp]_BitcoinC2S.tsv.gz\n195 [Timestamp]_BitcoinC2T.tsv.gz\n1   [Timestamp]_BitcoinGraph.tsv.gz\n195 [Timestamp]_BitcoinS2S.tsv.gz\n195 [Timestamp]_BitcoinT2T.tsv.gz\n195 [Timestamp]_byC2S_BitcoinB2S.tsv.gz\n195 [Timestamp]_byC2T_BitcoinB2T.tsv.gz\n195 [Timestamp]_byS2S_BitcoinB2S.tsv.gz\n195 [Timestamp]_byS2S_BitcoinS2B.tsv.gz\n195 [Timestamp]_byT2T_BitcoinB2T.tsv.gz\n195 [Timestamp]_byT2T_BitcoinT2B.tsv.gz\n1   unique_BitcoinScriptNode.tsv.gz\n1   unique_BitcoinTxNode.tsv.gz\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Determine the optimal heap size for the import process.\nFor a graph of this magnitude, memory configuration is critical for performance.\nPlease refer to ",(0,s.jsx)(t.a,{href:"https://neo4j.com/docs/operations-manual/current/performance/memory-configuration/",children:"Neo4j Memory Configuration Guide"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Execute the import command.\nNote that we use regex patterns (e.g., .",(0,s.jsx)(t.code,{children:"*BitcoinS2S.tsv.gz"}),") to ingest the batched edge files automatically."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:'sudo -u neo4j HEAP_SIZE=4G neo4j-admin database import full \\\n    --overwrite-destination neo4j \\\n    --nodes="$GDIR/BitcoinCoinbase.tsv.gz" \\\n    --nodes="$GDIR/BitcoinGraph_header.tsv.gz,$GDIR/0_BitcoinGraph.tsv.gz" \\\n    --nodes="$GDIR/BitcoinScriptNode_header.tsv.gz,$GDIR/unique_BitcoinScriptNode.tsv.gz" \\\n    --nodes="$GDIR/BitcoinTxNode_header.tsv.gz,$GDIR/unique_BitcoinTxNode.tsv.gz" \\\n    --relationships="$GDIR/BitcoinS2S_header.tsv.gz,$GDIR/.*BitcoinS2S.tsv.gz" \\\n    --relationships="$GDIR/BitcoinT2T_header.tsv.gz,$GDIR/.*BitcoinT2T.tsv.gz" \\\n    --relationships="$GDIR/BitcoinC2T_header.tsv.gz,$GDIR/.*BitcoinC2T.tsv.gz" \\\n    --relationships="$GDIR/BitcoinC2S_header.tsv.gz,$GDIR/.*BitcoinC2S.tsv.gz" \\\n    --relationships="$GDIR/BitcoinB2T_header.tsv.gz,$GDIR/.*BitcoinB2T.tsv.gz" \\\n    --relationships="$GDIR/BitcoinB2S_header.tsv.gz,$GDIR/.*BitcoinB2S.tsv.gz" \\\n    --relationships="$GDIR/BitcoinS2B_header.tsv.gz,$GDIR/.*BitcoinS2B.tsv.gz" \\\n    --relationships="$GDIR/BitcoinT2B_header.tsv.gz,$GDIR/.*BitcoinT2B.tsv.gz" \\\n    --delimiter="\\t" \\\n    --array-delimiter=";" \\\n    --verbose \\\n    --skip-duplicate-nodes\n'})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Once the import concludes, restart the Neo4j service.\nWe also recommend installing the\n",(0,s.jsx)(t.a,{href:"https://neo4j.com/docs/apoc/current/installation/",children:"APOC library"}),",\nas it is needed in EBA for sampling communities."]}),"\n"]}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,t,i)=>{i.d(t,{R:()=>r,x:()=>a});var n=i(6540);const s={},o=n.createContext(s);function r(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);