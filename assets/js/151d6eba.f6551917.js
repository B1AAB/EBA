"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[30],{4357:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"bitcoin/etl/s5a-import","title":"Import into Neo4j","description":"Step 5. Import into neo4j","source":"@site/docs/bitcoin/etl/s5a-import.md","sourceDirName":"bitcoin/etl","slug":"/bitcoin/etl/import","permalink":"/docs/bitcoin/etl/import","draft":false,"unlisted":false,"editUrl":"https://github.com/B1AAB/EBA/edit/main/website/docs/bitcoin/etl/s5a-import.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Import into Neo4j","description":"Step 5. Import into neo4j","sidebar_position":4,"slug":"/bitcoin/etl/import"},"sidebar":"tutorialSidebar","previous":{"title":"TXO Lifecycle","permalink":"/docs/bitcoin/etl/txo-lifecycle"},"next":{"title":"Restore Database Dump","permalink":"/docs/bitcoin/etl/restore"}}');var s=t(4848),o=t(8453);const a={title:"Import into Neo4j",description:"Step 5. Import into neo4j",sidebar_position:4,slug:"/bitcoin/etl/import"},r=void 0,c={},d=[{value:"Checkpoint: using pre-generated graph data",id:"checkpoint-using-pre-generated-graph-data",level:3},{value:"Import into the database",id:"import",level:3}];function l(e){const n={a:"a",admonition:"admonition",annotation:"annotation",code:"code",em:"em",h3:"h3",li:"li",math:"math",mo:"mo",mrow:"mrow",ol:"ol",p:"p",pre:"pre",semantics:"semantics",span:"span",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.admonition,{title:"Do I need to run the bulk import process?",type:"tip",children:[(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Yes,"}),"\nif you need to modify the graph structure or append new data that is not included in\n",(0,s.jsx)(n.a,{href:"/releases/tags/data-releases",children:"our release"}),".\n",(0,s.jsx)(n.em,{children:"Note: This is highly resource-intensive and can take 2-3 weeks on a high-end desktop computer."})]}),(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"No,"}),"\nif you simply want to explore the graph or\n",(0,s.jsx)(n.a,{href:"/docs/bitcoin/sampling/overview",children:"sample communities"})," from the dataset.\nIn this case, ",(0,s.jsx)(n.a,{href:"./restore",children:"restore database dump"})," instead; it bypasses the weeks-long processing time required for the bulk import described on this page."]})]}),"\n",(0,s.jsx)(n.p,{children:"On this page, we walk through the steps required to import the Bitcoin graph from batched TSV files into a Neo4j database."}),"\n",(0,s.jsx)(n.h3,{id:"checkpoint-using-pre-generated-graph-data",children:"Checkpoint: using pre-generated graph data"}),"\n",(0,s.jsxs)(n.p,{children:["If you chose to skip the\n",(0,s.jsx)(n.a,{href:"./node-sync",children:"sync a Bitcoin node"})," ",(0,s.jsxs)(n.span,{className:"katex",children:[(0,s.jsx)(n.span,{className:"katex-mathml",children:(0,s.jsx)(n.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,s.jsxs)(n.semantics,{children:[(0,s.jsx)(n.mrow,{children:(0,s.jsx)(n.mo,{children:"\u2192"})}),(0,s.jsx)(n.annotation,{encoding:"application/x-tex",children:"\\rightarrow"})]})})}),(0,s.jsx)(n.span,{className:"katex-html","aria-hidden":"true",children:(0,s.jsxs)(n.span,{className:"base",children:[(0,s.jsx)(n.span,{className:"strut",style:{height:"0.3669em"}}),(0,s.jsx)(n.span,{className:"mrel",children:"\u2192"})]})})]}),"\n",(0,s.jsx)(n.a,{href:"./traverse",children:"traverse"})," steps, you do ",(0,s.jsx)(n.em,{children:"not"})," have the TSV files yet.\nInstead, you can download the data we have prepared,\nwhich encompasses all blocks up to height ",(0,s.jsx)(n.code,{children:"863000"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.em,{children:["Note: If you ",(0,s.jsx)(n.strong,{children:"did run"})," the\n",(0,s.jsx)(n.a,{href:"./node-sync",children:"sync a Bitcoin node"})," and\n",(0,s.jsx)(n.a,{href:"./traverse",children:"traverse"})," steps and\ngenerated your own TSV files, you can skip this step and\nproceed directly to the ",(0,s.jsx)(n.a,{href:"#import",children:"import"})," step below."]})}),"\n",(0,s.jsx)(n.admonition,{title:"Resource Requirements",type:"danger",children:(0,s.jsxs)(n.p,{children:["This process involves downloading nearly ",(0,s.jsx)(n.code,{children:"1.2 TB"})," of data;\nensure you are using a stable connection without data caps and\nhave at least ",(0,s.jsx)(n.code,{children:"1.2 TB"})," of free disk space."]})}),"\n",(0,s.jsx)(n.p,{children:"You may take the following steps to download the graph in TSV files."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html",children:"Install the AWS CLI"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Configure environment variable to specify the target directory."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'export GDIR="/mnt/download/path"\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Download the TSV files."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'aws s3 sync s3://bitcoin-graph/v1/data_to_import_neo4j/ "${GDIR}" --no-sign-request    \n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"import",children:"Import into the database"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://neo4j.com/docs/operations-manual/4.4/tools/neo4j-admin/neo4j-admin-import/",children:(0,s.jsx)(n.code,{children:"neo4j-admin"})}),"\noffers the highest throughput method for populating a massive database.\nIts primary constraint is that it requires an empty database,\nmeaning it does not support incremental updates to an existing graph."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Install ",(0,s.jsx)(n.a,{href:"/docs/gs/graphdb#neo4j",children:"neo4j graph database"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://neo4j.com/docs/desktop/current/operations/database-management/#_create_a_new_database",children:"Create a neo4j database"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"If you are using an existing database instance,\nensure the target database is empty and shut down."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"sudo systemctl stop neo4j\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Set an environment variable pointing to the directory containing the Bitcoin graph TSV files."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'export GDIR="<set to the dir that contains graph data>"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Verify that your data directory contains the correctly batched files.\nYou can use the following command to inspect the file distribution by type\n(ignoring timestamp prefixes):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'ls -1 | sed -E "s/^[0-9]+_/[Timestamp]_/" | sort | uniq -c\n'})}),"\n",(0,s.jsxs)(n.p,{children:["You should see header files (e.g., ",(0,s.jsx)(n.code,{children:"BitcoinGraph_header.tsv.gz"}),"),\nbatched edge files (e.g., ",(0,s.jsx)(n.code,{children:"195 [Timestamp]_BitcoinS2S.tsv.gz"}),"), and the unique node files."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"1   BitcoinB2S_header.tsv.gz\n1   BitcoinB2T_header.tsv.gz\n1   BitcoinC2S_header.tsv.gz\n1   BitcoinC2T_header.tsv.gz\n1   BitcoinCoinbase.tsv.gz\n1   BitcoinGraph_header.tsv.gz\n1   BitcoinS2B_header.tsv.gz\n1   BitcoinS2S_header.tsv.gz\n1   BitcoinScriptNode_header.tsv.gz\n1   BitcoinT2B_header.tsv.gz\n1   BitcoinT2T_header.tsv.gz\n1   BitcoinTxNode_header.tsv.gz\n195 [Timestamp]_BitcoinC2S.tsv.gz\n195 [Timestamp]_BitcoinC2T.tsv.gz\n1   [Timestamp]_BitcoinGraph.tsv.gz\n195 [Timestamp]_BitcoinS2S.tsv.gz\n195 [Timestamp]_BitcoinT2T.tsv.gz\n195 [Timestamp]_byC2S_BitcoinB2S.tsv.gz\n195 [Timestamp]_byC2T_BitcoinB2T.tsv.gz\n195 [Timestamp]_byS2S_BitcoinB2S.tsv.gz\n195 [Timestamp]_byS2S_BitcoinS2B.tsv.gz\n195 [Timestamp]_byT2T_BitcoinB2T.tsv.gz\n195 [Timestamp]_byT2T_BitcoinT2B.tsv.gz\n1   unique_BitcoinScriptNode.tsv.gz\n1   unique_BitcoinTxNode.tsv.gz\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Determine the optimal heap size for the import process.\nFor a graph of this magnitude, memory configuration is critical for performance.\nPlease refer to ",(0,s.jsx)(n.a,{href:"https://neo4j.com/docs/operations-manual/current/performance/memory-configuration/",children:"Neo4j Memory Configuration Guide"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Execute the import command.\nNote that we use regex patterns (e.g., .",(0,s.jsx)(n.code,{children:"*BitcoinS2S.tsv.gz"}),") to ingest the batched edge files automatically."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'sudo -u neo4j HEAP_SIZE=4G neo4j-admin database import full \\\n    --overwrite-destination neo4j \\\n    --nodes="$GDIR/BitcoinCoinbase.tsv.gz" \\\n    --nodes="$GDIR/BitcoinGraph_header.tsv.gz,$GDIR/0_BitcoinGraph.tsv.gz" \\\n    --nodes="$GDIR/BitcoinScriptNode_header.tsv.gz,$GDIR/unique_BitcoinScriptNode.tsv.gz" \\\n    --nodes="$GDIR/BitcoinTxNode_header.tsv.gz,$GDIR/unique_BitcoinTxNode.tsv.gz" \\\n    --relationships="$GDIR/BitcoinS2S_header.tsv.gz,$GDIR/.*BitcoinS2S.tsv.gz" \\\n    --relationships="$GDIR/BitcoinT2T_header.tsv.gz,$GDIR/.*BitcoinT2T.tsv.gz" \\\n    --relationships="$GDIR/BitcoinC2T_header.tsv.gz,$GDIR/.*BitcoinC2T.tsv.gz" \\\n    --relationships="$GDIR/BitcoinC2S_header.tsv.gz,$GDIR/.*BitcoinC2S.tsv.gz" \\\n    --relationships="$GDIR/BitcoinB2T_header.tsv.gz,$GDIR/.*BitcoinB2T.tsv.gz" \\\n    --relationships="$GDIR/BitcoinB2S_header.tsv.gz,$GDIR/.*BitcoinB2S.tsv.gz" \\\n    --relationships="$GDIR/BitcoinS2B_header.tsv.gz,$GDIR/.*BitcoinS2B.tsv.gz" \\\n    --relationships="$GDIR/BitcoinT2B_header.tsv.gz,$GDIR/.*BitcoinT2B.tsv.gz" \\\n    --delimiter="\\t" \\\n    --array-delimiter=";" \\\n    --verbose \\\n    --skip-duplicate-nodes\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Once the import concludes, restart the Neo4j service.\nWe also recommend installing the\n",(0,s.jsx)(n.a,{href:"https://neo4j.com/docs/apoc/current/installation/",children:"APOC library"}),",\nas it is needed in EBA for sampling communities."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"./db-conf",children:"Update Neo4j database configuration"}),"."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var i=t(6540);const s={},o=i.createContext(s);function a(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);